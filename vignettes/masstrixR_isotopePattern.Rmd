---
title: "Annotation and Isotope Pattern Matching with masstrixR"
author: "Michael"
date: "3 August 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# MassTRIX in R - Annotating MS1 data made easy...

## Introduction

Multiple annotations might exist for a single cluster, e.g. isobaric annotations of [M+H]^+^ and [M+Na]^+^. Isotope pattern can help to resolve this problem. <code>masstrixR</code> uses functions from the <code>enviPat</code> package to predict isotope patterns from ion formulas and given MS resolution.

## Matching of isotope patterns

Isotope patterns can be predicted using the <code>generateIsoPattern()</code> function. Input required for this function is a ion sum formula, the adduct type (see masstrixR_basicUse.Rmd). The adduct is required to set the correct charge for isotope pattern calculation. The predicted isotope pattern is return as <code>Spectrum1</code> object from <code>MSnbase</code>.

```{r, basic isotope pattern prediction}
library(masstrixR)

# generate isotopic pattern for [M+Na]+ adduct of Glucose
# default parameters are used (treshold = 0.01, resolution = 50000)
generateIsoPattern("C6H12O6Na", "M+Na")

# use of lower resolution
generateIsoPattern("C6H12O6Na", "M+Na", resolution = 5000)
```

## Extract isotope pattern information from Genedata .gda output

Genedata Expressionist for MS 11.0 can perform isotope pattern grouping, but does not report the isotope pattern back to the user. The following code lines reconstruct isotope patterns from two .gda files. The first one contains the data table with all clusters (after isotope pattern grouping), while the second one contains the corresponding peaks. Group annotations are preserved in both files and can be used to link clusters with peaks and reconstruct the isotope pattern in each sample. The clusters are annotated based 

```{r read data and annotate}
# load required libraries
library(stringr)

# read cluster
exampleGDAClusters <- readGdaFile("..\\example\\NaAcHILICPos_Cluster.gda")
clusterRowAnno <- exampleGDAClusters[[3]]
clusterRowAnno$cluster <- row.names(clusterRowAnno)

# read peaks
exampleGDAPeaks <- readGdaFile("..\\example\\NaAcHILICPos_Peaks.gda")
peaksRowAnno <- exampleGDAPeaks[[3]]
peaksRowAnno$Peak <- row.names(peaksRowAnno)

# get sample names
sampleNames <- exampleGDAClusters[[2]]$SampleNames

# get peak data to reconstruct isotope pattern
peaksData <- exampleGDAPeaks[[1]]

# read YMDB text file and annotated example data
compoundList <- data.frame(read.table("..\\DBs\\Txt\\ymdb_20180731.txt", sep = "\t", header = T, stringsAsFactors = F, comment.char = ""))
annotationResultsLookup <- mzLookUp(clusterRowAnno[c("cluster","m.z", "RT")], compoundList, mzTol = 0.005, tolType = "abs", c("M+H", "M+Na"))
```

## Perform isotope pattern matching

```{r}
# create empty list
isoPatternList <- list()

# iterate through annotation results
for(i in 1:nrow(clusterRowAnno)) {
  
  annotatedCluster <- clusterRowAnno$cluster[i]
  
  # some required variables
  intFinal <- vector()
  tic <- 0

  # get number of cluster
  clusterNumber <- str_extract(annotatedCluster, "\\d+")
  
  # isolate peaknumbers
  peaks <- peaksRowAnno$Peak[which(peaksRowAnno$`Cluster [C]` == clusterNumber)]

  # get m/z values
  mz <- peaksRowAnno$m.z[which(peaksRowAnno$Peak %in% peaks)]
  
  peakList <- cbind.data.frame(peaksData[peaks,], mz)
  
  # get intensity values from each sample and use only the pattern with highest TIC
  isoPatternList <- c(isoPatternList, reconstructIsoPattern(peakList, "highestTic"))
  
}

# iterate over annotation results
for(i in 1:nrow(annotationResultsLookup)) {
  
  # predict iso pattern
  predicted <- generateIsoPattern(annotationResultsLookup$ionFormula[i], annotationResultsLookup$adductType[i], plotit = FALSE)
  
  measured <- isoPatternList[unlist(lapply(isoPatternList, function(x) {return(x@featureId)})) == annotationResultsLookup$cluster[i]][[1]]
  
  annotationResultsLookup$isoMatch[i] <- 1000 - compareSpectra(measured, predicted, fun = "dotproduct") * 1000
}

```

## prepare for SIRIUS output

```{r}
# read peak match table and filter only peaks handled in this example
peakMatchTable <- readPmt("..\\example\\NaAc_Test.pmt")
peakMatchTable <- peakMatchTable[which(peakMatchTable$cluster %in% clusterRowAnno$cluster),]

# iterate over samples
for(sample in sampleNames) {
  
  # read fitting mgf file
  ms2data <- readMgfData(paste0("..\\example\\NaAcHILICPos\\", sample, ".mgf"))
  
  #get all Ms2 spectra
  ms2 <- spectra(filterMsLevel(ms2data, msLevel = 2))
  
  
  for(i in 1:nrow(peakMatchTable[which(peakMatchTable$sampleName == sample),])) {
    scanIndex <- peakMatchTable$content[i]
    singleSpec <- ms2[which(unlist(lapply(ms2, function(x) {return(x@scanIndex)})) == scanIndex)]
    
    print(singleSpec)
  }
  
}

# iterate over iso pattern
for(isoPattern in isoPatternList) {
  print(isoPattern@featureId)
  print(isoPattern@sample)
  print(isoPattern@monoMz)
}


[1] "Cluster_2996"
[1] "NaAc_StdMix_1-B,1_05_19682"
[1] 245.0953329



ms2data <-  readMgfData(paste0("..\\example\\NaAcHILICPos\\", "NaAc_StdMix_1-B,1_05_19682", ".mgf"))

#get all Ms2 spectra
ms2 <- spectra(filterMsLevel(ms2data, msLevel = 2))

scanIndex <- peakMatchTable$content[which(peakMatchTable$sampleName == "NaAc_StdMix_1-B,1_05_19682" &  peakMatchTable$cluster == "Cluster_2996")]

writeSirius(isoPattern, singleSpec[[1]], "test.mgf")

```

