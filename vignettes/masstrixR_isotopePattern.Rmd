---
title: "Annotation and Isotope Pattern Matching with masstrixR"
author: "Michael"
date: "3 August 2018"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Annotation and Isotope Pattern Matching with masstrixR}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# MassTRIX in R - Annotating MS1 data made easy...

## Introduction

Multiple annotations might exist for a single cluster, e.g. isobaric annotations of [M+H]^+^ and [M+Na]^+^. Isotope pattern can help to resolve this problem. <code>masstrixR</code> uses functions from the <code>enviPat</code> package to predict isotope patterns from ion formulas and given MS resolution.

## Matching of isotope patterns

Isotope patterns can be predicted using the <code>generateIsoPattern()</code> function. Input required for this function is a ion sum formula, the adduct type (see masstrixR_basicUse.Rmd). The adduct is required to set the correct charge for isotope pattern calculation. The predicted isotope pattern is return as <code>Spectrum1</code> object from <code>MSnbase</code>.

```{r, basic isotope pattern prediction}
library(masstrixR)

# generate isotopic pattern for [M+Na]+ adduct of Glucose
# default parameters are used (treshold = 0.01, resolution = 50000)
#predictIsoPattern("C6H12O6Na", "M+Na")

# use of lower resolution
#predictIsoPattern("C6H12O6Na", "M+Na", resolution = 5000)
```

## Extract isotope pattern information from Genedata .gda output

Genedata Expressionist for MS 11.0 can perform isotope pattern grouping, but does not report the isotope pattern back to the user. The following code lines reconstruct isotope patterns from two .gda files. The first one contains the data table with all clusters (after isotope pattern grouping), while the second one contains the corresponding peaks. Group annotations are preserved in both files and can be used to link clusters with peaks and reconstruct the isotope pattern in each sample. The clusters are annotated based 

```{r read data and annotate}
# load required libraries
library(masstrixR)
library(stringr)

# read cluster
exampleGDAClusters <- readGdaFile(system.file("extdata", "NaAcHILICPos_Cluster.gda", package = 'masstrixR'))
clusterRowAnno <- exampleGDAClusters[[3]]
clusterRowAnno$Cluster <- row.names(clusterRowAnno)

# read peaks
exampleGDAPeaks <- readGdaFile(system.file("extdata", "NaAcHILICPos_Peaks.gda", package = 'masstrixR'))
peaksRowAnno <- exampleGDAPeaks[[3]]
peaksRowAnno$Peak <- row.names(peaksRowAnno)
peaksRowAnno$Cluster <- paste("Cluster_", peaksRowAnno$`Cluster [C]`, sep = "")

# get sample names
sampleNames <- exampleGDAClusters[[2]]$SampleNames

```

## Reconstruct isotope pattern

Isotope pattern can be reconstructed from a file containing peaks and clusters.

```{r}
# get peak data to reconstruct isotope pattern
peaksData <- exampleGDAPeaks[[1]]

# create data to generate isotope pattern
peaks <- merge(peaksData, peaksRowAnno, by = 0)

# generate isotope pattern
isoPatternList <- reconstructIsoPattern(peaks, sampleNames)
head(isoPatternList)

# combine isotope pattern
combinedIsoPatternList <- combineSpectra(isoPatternList, fcol = "Cluster", mzd = 0.005, fun = consensusSpectrum)

plot(mz(combinedIsoPatternList[[1]]), intensity(combinedIsoPatternList[[1]]), type = "h")
```


## Perform isotope pattern matching


```{r}
# read YMDB text file and annotated example data
compoundList <- data.frame(read.table(system.file("extdata", "ymdb_20180731.txt", package = 'masstrixR'), sep = "\t", header = T, stringsAsFactors = F, comment.char = ""))

adducts <- c("[M+H]+", "[M+Na]+")

# create compound list for DB creation
newCompoundList <- prepareCompoundList(compoundList, adductList = adducts, rt = FALSE, ccs = FALSE, extId = FALSE)

annotationResultsLookup <- mzLookUp(clusterRowAnno[c("Cluster","m.z", "RT")], newCompoundList, mzTol = 0.005, mzTolType = "abs")
```



```{r}
# iterate through annotation results
for(i in 1:nrow(annotationResultsLookup)) {

  # get cluster id
  cluster <- annotationResultsLookup$Cluster[i]
  
  print(cluster)
  
  # get measured spectrum
  measured <- combinedIsoPatternList[cluster][[1]]
  
  plot(mz(measured), intensity(measured), type = "h")

  # predict theoretical spectrum
  theoretical <- predictIsoPattern(annotationResultsLookup$ionFormula[i], 1, treshold = 0.01, resolution = 15000, plotit = FALSE)
  
  mz <- mz(theoretical)
  int <- intensity(theoretical) / 100 * max(intensity(measured))
  
  mz <- mz[int >= 2500]
  int <- int[int >= 2500]
  
  theoretical@mz <- mz
  theoretical@intensity <- int
  
  plot(mz(theoretical), intensity(theoretical), type = "h")

  # compare measured and theoretical spectrum
  similarity <- compareSpectra(measured, theoretical, fun = isoPatternSimilarity, mzTol = 0.005)
  
  print(similarity)
  
  annotationResultsLookup$isoPatternSimilarity[i] <- similarity
}


```
